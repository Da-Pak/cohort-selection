# Cohort Selection - ì˜ë£Œ í…ìŠ¤íŠ¸ í•„í„°ë§ ì‹œìŠ¤í…œ

ì˜ë£Œ í…ìŠ¤íŠ¸ ë°ì´í„°ì—ì„œ íŠ¹ì • ì¡°ê±´ì— ë§ëŠ” í™˜ì ì½”í˜¸íŠ¸ë¥¼ ì„ ë³„í•˜ëŠ” LLM ê¸°ë°˜ í•„í„°ë§ ì‹œìŠ¤í…œì…ë‹ˆë‹¤. LangGraphì˜ ì„œë¸Œê·¸ë˜í”„ íŒ¨í„´ì„ í™œìš©í•˜ì—¬ ê°•ë ¥í•œ ì¬ì‹œë„ ë©”ì»¤ë‹ˆì¦˜ê³¼ ê²€ì¦ ë¡œì§ì„ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.

## ğŸ—ï¸ ì•„í‚¤í…ì²˜ ê°œìš”

### ì„œë¸Œê·¸ë˜í”„ íŒ¨í„´ (Nested Graph Pattern)
ë³¸ ì‹œìŠ¤í…œì€ LangGraphì˜ ì„œë¸Œê·¸ë˜í”„ íŒ¨í„´ì„ ì±„íƒí•˜ì—¬ ë‹¤ìŒê³¼ ê°™ì€ êµ¬ì¡°ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤:

- **ë©”ì¸ ê·¸ë˜í”„**: ì „ì²´ ë°ì´í„° ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸ ê´€ë¦¬
- **ì„œë¸Œê·¸ë˜í”„**: ë‹¨ì¼ í…ìŠ¤íŠ¸ ì²˜ë¦¬ ë° ê²€ì¦ ë£¨í”„

```
ë©”ì¸ ê·¸ë˜í”„ (FilterState)
â”œâ”€â”€ ë°ì´í„° ë¡œë“œ
â”œâ”€â”€ ì»¨í…ìŠ¤íŠ¸ ìƒì„±  
â”œâ”€â”€ ëª¨ë“  í…ìŠ¤íŠ¸ ì²˜ë¦¬ â”€â”€â”€â”€â”€â”
â”œâ”€â”€ ê²°ê³¼ ë§ˆë¬´ë¦¬          â”‚
â””â”€â”€ ì˜¤ë¥˜ ì²˜ë¦¬            â”‚
                        â”‚
ì„œë¸Œê·¸ë˜í”„ (SingleTextState) â†â”€â”˜
â”œâ”€â”€ ì¶”ë¡  â†’ ë¬¸ì¥ê²€ì¦
â””â”€â”€ ì‹¤íŒ¨ ì‹œ ìµœëŒ€ 5ë²ˆ ì¬ì‹œë„
```

## ğŸ”„ ì›Œí¬í”Œë¡œìš°

### ë©”ì¸ ê·¸ë˜í”„ ì›Œí¬í”Œë¡œìš°
1. **ë°ì´í„° ë¡œë“œ**: ìºì‹œì—ì„œ ë°ì´í„°í”„ë ˆì„ ë¡œë“œ ë° ê²€ì¦
2. **ì»¨í…ìŠ¤íŠ¸ ìƒì„±**: ì‚¬ìš©ì ì§ˆë¬¸ ê¸°ë°˜ ì˜ë£Œ ì»¨í…ìŠ¤íŠ¸ ìƒì„±
3. **í…ìŠ¤íŠ¸ ì²˜ë¦¬**: ê° í…ìŠ¤íŠ¸ë§ˆë‹¤ ì„œë¸Œê·¸ë˜í”„ í˜¸ì¶œ
4. **ê²°ê³¼ ë§ˆë¬´ë¦¬**: í•„í„°ë§ëœ ë°ì´í„°í”„ë ˆì„ ìƒì„± ë° ì €ì¥

### ì„œë¸Œê·¸ë˜í”„ ì›Œí¬í”Œë¡œìš° (ë‹¨ì¼ í…ìŠ¤íŠ¸ ì²˜ë¦¬)
```mermaid
graph TD
    A[ì¶”ë¡  ì‹œì‘] --> B{ì¶”ë¡  ì„±ê³µ?}
    B -->|ì„±ê³µ| C[ë¬¸ì¥ ê²€ì¦]
    B -->|ì‹¤íŒ¨ & ì¬ì‹œë„ ê°€ëŠ¥| A
    B -->|ì¬ì‹œë„ ì´ˆê³¼| G[ì™„ë£Œ]
    
    C --> D{ë¬¸ì¥ ê²€ì¦ í†µê³¼?}
    D -->|í†µê³¼| G[ì™„ë£Œ]
    D -->|ì‹¤íŒ¨ & ì¬ì‹œë„ ê°€ëŠ¥| A
    D -->|ì¬ì‹œë„ ì´ˆê³¼| G
```

## ğŸ“Š ìƒíƒœ ê´€ë¦¬

### FilterState (ë©”ì¸ ê·¸ë˜í”„)
```python
class FilterState(TypedDict):
    # ì…ë ¥ ë°ì´í„°
    question: str              # ì‚¬ìš©ì ì§ˆë¬¸
    data_id: str              # ë°ì´í„° ID
    task_id: str              # ì‘ì—… ID
    target_column: str        # ëŒ€ìƒ ì—´
    temperature: float        # LLM ì˜¨ë„
    
    # ì²˜ë¦¬ ê²°ê³¼
    context: str              # ìƒì„±ëœ ì»¨í…ìŠ¤íŠ¸
    dataframe: pd.DataFrame   # ì›ë³¸ ë°ì´í„°
    results: List[Dict]       # ì²˜ë¦¬ ê²°ê³¼
    filtered_dataframe: pd.DataFrame  # í•„í„°ë§ëœ ë°ì´í„°
    
    # ìƒíƒœ ê´€ë¦¬
    status: str               # ì²˜ë¦¬ ìƒíƒœ
    progress: float           # ì§„í–‰ë¥ 
    error: str                # ì˜¤ë¥˜ ë©”ì‹œì§€
```

### SingleTextState (ì„œë¸Œê·¸ë˜í”„)
```python
class SingleTextState(TypedDict):
    # ì…ë ¥ ë°ì´í„°
    text: str                 # ì²˜ë¦¬í•  í…ìŠ¤íŠ¸
    context: str              # ì˜ë£Œ ì»¨í…ìŠ¤íŠ¸
    question: str             # ì‚¬ìš©ì ì§ˆë¬¸
    
    # ì²˜ë¦¬ ê²°ê³¼
    sentence: str             # ì¶”ì¶œëœ ë¬¸ì¥
    opinion: str              # LLM ì˜ê²¬
    verified_sentence: bool   # ë¬¸ì¥ ê²€ì¦ ê²°ê³¼
    
    # ë£¨í”„ ì œì–´
    retry_count: int          # í˜„ì¬ ì¬ì‹œë„ íšŸìˆ˜
    max_retries: int          # ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ (ê¸°ë³¸: 5)
    error: str                # ì˜¤ë¥˜ ë©”ì‹œì§€
```

## ğŸ”§ ì£¼ìš” êµ¬ì„± ìš”ì†Œ

### ì„œë¸Œê·¸ë˜í”„ ë…¸ë“œë“¤

#### 1. `inference_single_text`
- **ê¸°ëŠ¥**: ë‹¨ì¼ í…ìŠ¤íŠ¸ì— ëŒ€í•œ LLM ì¶”ë¡  ìˆ˜í–‰
- **ì…ë ¥**: í…ìŠ¤íŠ¸, ì»¨í…ìŠ¤íŠ¸, ì§ˆë¬¸
- **ì¶œë ¥**: ì¶”ì¶œëœ ë¬¸ì¥ê³¼ ì˜ê²¬
- **ì‹¤íŒ¨ ì¡°ê±´**: ì¶”ë¡  ì˜¤ë¥˜, ë¶ˆì™„ì „í•œ ê²°ê³¼

#### 2. `validate_sentence_node`
- **ê¸°ëŠ¥**: ì¶”ì¶œëœ ë¬¸ì¥ì´ ì›ë³¸ í…ìŠ¤íŠ¸ì—ì„œ ì‹¤ì œ ì¡´ì¬í•˜ëŠ”ì§€ ê²€ì¦
- **ê²€ì¦ ë°©ë²•**: ë¬¸ìì—´ í¬í•¨ ê´€ê³„ ë° ìœ ì‚¬ë„ ê²€ì‚¬
- **ì‹¤íŒ¨ ì¡°ê±´**: ë¬¸ì¥ì´ ì›ë³¸ì— ì¡´ì¬í•˜ì§€ ì•ŠìŒ



### ì¡°ê±´ë¶€ ë¼ìš°íŒ…

#### `route_after_inference`
```python
def route_after_inference(state) -> Literal["validate_sentence", "inference", "completed"]:
    # ìµœëŒ€ ì¬ì‹œë„ ì´ˆê³¼ â†’ completed
    # ì¶”ë¡  ì‹¤íŒ¨ â†’ inference (ì¬ì‹œë„)
    # ì¶”ë¡  ì„±ê³µ â†’ validate_sentence
```

#### `route_after_sentence_validation`
```python
def route_after_sentence_validation(state) -> Literal["inference", "completed"]:
    # ìµœëŒ€ ì¬ì‹œë„ ì´ˆê³¼ â†’ completed
    # ë¬¸ì¥ ê²€ì¦ ì„±ê³µ â†’ completed
    # ë¬¸ì¥ ê²€ì¦ ì‹¤íŒ¨ â†’ inference (ì¬ì‹œë„)
```

## ğŸ”„ ì¬ì‹œë„ ë©”ì»¤ë‹ˆì¦˜

### ì¬ì‹œë„ ì¡°ê±´
- **ì¶”ë¡  ì‹¤íŒ¨**: LLM ì˜¤ë¥˜, ë¶ˆì™„ì „í•œ ì‘ë‹µ
- **ë¬¸ì¥ ê²€ì¦ ì‹¤íŒ¨**: ì¶”ì¶œëœ ë¬¸ì¥ì´ ì›ë³¸ì— ì¡´ì¬í•˜ì§€ ì•ŠìŒ

### ì¬ì‹œë„ ì œí•œ
- **ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜**: 5ë²ˆ (ì„¤ì • ê°€ëŠ¥)
- **ì¬ì‹œë„ ì´ˆê³¼ ì‹œ**: í˜„ì¬ ìƒíƒœë¡œ ì²˜ë¦¬ ì™„ë£Œ
- **ê° í…ìŠ¤íŠ¸ë³„ ë…ë¦½ì **: í•œ í…ìŠ¤íŠ¸ì˜ ì‹¤íŒ¨ê°€ ë‹¤ë¥¸ í…ìŠ¤íŠ¸ì— ì˜í–¥ ì—†ìŒ

## ğŸš€ ì‚¬ìš©ë²•

### ê¸°ë³¸ ì‚¬ìš©ë²•
```python
from graph.filter_graph import filter_runner

# í•„í„°ë§ ì‹¤í–‰
filtered_df, result_id = filter_runner.run_filter(
    question="ë‹¹ë‡¨ë³‘ í™˜ìë¥¼ ì°¾ì•„ì£¼ì„¸ìš”",
    data_id="patient_data_001",
    task_id="task_123",
    target_column="medical_notes",
    temperature=0.7
)
```

### ì„¤ì • ì˜µì…˜
```python
# configì—ì„œ ì„¤ì • ê°€ëŠ¥í•œ ì˜µì…˜ë“¤
{
    "llm_config": {
        "llm_type": "gpt-4",
        "temperature": 0.7
    },
    "retry_count": 5,              # ì„œë¸Œê·¸ë˜í”„ì—ì„œ ì‚¬ìš©

}
```

## ğŸ“ íŒŒì¼ êµ¬ì¡°

```
graph/
â”œâ”€â”€ state.py              # ìƒíƒœ í´ë˜ìŠ¤ ì •ì˜
â”œâ”€â”€ nodes.py              # ë…¸ë“œ í•¨ìˆ˜ë“¤ ë° ì„œë¸Œê·¸ë˜í”„
â”œâ”€â”€ filter_graph.py       # ë©”ì¸ ê·¸ë˜í”„ êµ¬ì„±
â””â”€â”€ agents/
    â”œâ”€â”€ prompt_generator.py    # ì»¨í…ìŠ¤íŠ¸ ìƒì„±
    â””â”€â”€ llm_inference.py       # LLM ì¶”ë¡ 
```

### ì£¼ìš” íŒŒì¼ ì„¤ëª…

#### `state.py`
- `FilterState`: ë©”ì¸ ê·¸ë˜í”„ ìƒíƒœ ì •ì˜
- `SingleTextState`: ì„œë¸Œê·¸ë˜í”„ ìƒíƒœ ì •ì˜
- ì´ˆê¸° ìƒíƒœ ìƒì„± í•¨ìˆ˜ë“¤

#### `nodes.py`
- ì„œë¸Œê·¸ë˜í”„ ë…¸ë“œ í•¨ìˆ˜ë“¤
- ì¡°ê±´ë¶€ ë¼ìš°íŒ… í•¨ìˆ˜ë“¤
- ì„œë¸Œê·¸ë˜í”„ ìƒì„± ë° ì»´íŒŒì¼
- ë©”ì¸ ê·¸ë˜í”„ ë…¸ë“œ í•¨ìˆ˜ë“¤

#### `filter_graph.py`
- ë©”ì¸ ê·¸ë˜í”„ êµ¬ì„± ë° ì»´íŒŒì¼
- `FilterRunner` í´ë˜ìŠ¤
- ê·¸ë˜í”„ ì‹¤í–‰ ì¸í„°í˜ì´ìŠ¤

## ğŸ” ëª¨ë‹ˆí„°ë§ ë° ë””ë²„ê¹…

### ë¡œê¹…
- ê° ë‹¨ê³„ë³„ ìƒì„¸ ë¡œê·¸ ì œê³µ
- ì¬ì‹œë„ íšŸìˆ˜ ë° ì‹¤íŒ¨ ì›ì¸ ì¶”ì 
- ì²˜ë¦¬ ì§„í–‰ë¥  ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸

### ìƒíƒœ ì¶”ì 
```python
# ì‘ì—… ìƒíƒœ ì‹¤ì‹œê°„ ì¡°íšŒ
update_task_status(task_id, status, progress, message)
```

### ì˜¤ë¥˜ ì²˜ë¦¬
- ê° ë…¸ë“œë³„ ì˜ˆì™¸ ì²˜ë¦¬
- ì•ˆì „í•œ ì‹¤íŒ¨ ì²˜ë¦¬ (graceful degradation)
- ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ë¶€ë¶„ ê²°ê³¼ ë°˜í™˜

## ğŸ¯ ì¥ì 

### 1. **ê°•ë ¥í•œ ì¬ì‹œë„ ë©”ì»¤ë‹ˆì¦˜**
- ê° ê²€ì¦ ë‹¨ê³„ì—ì„œ ì‹¤íŒ¨ ì‹œ ìë™ ì¬ì‹œë„
- ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ë¡œ ë¬´í•œ ë£¨í”„ ë°©ì§€

### 2. **ë…ë¦½ì ì¸ í…ìŠ¤íŠ¸ ì²˜ë¦¬**
- ê° í…ìŠ¤íŠ¸ë³„ë¡œ ë…ë¦½ì ì¸ ì„œë¸Œê·¸ë˜í”„ ì‹¤í–‰
- í•œ í…ìŠ¤íŠ¸ì˜ ì‹¤íŒ¨ê°€ ì „ì²´ì— ì˜í–¥ ì—†ìŒ

### 3. **ëª…í™•í•œ ìƒíƒœ ê´€ë¦¬**
- ê° ë‹¨ê³„ë³„ ìƒíƒœ ëª…í™•íˆ êµ¬ë¶„
- ì‹¤ì‹œê°„ ì§„í–‰ë¥  ì¶”ì 

### 4. **í™•ì¥ ê°€ëŠ¥í•œ êµ¬ì¡°**
- ìƒˆë¡œìš´ ê²€ì¦ ë‹¨ê³„ ì‰½ê²Œ ì¶”ê°€ ê°€ëŠ¥
- ë‹¤ì–‘í•œ ë¼ìš°íŒ… ì¡°ê±´ êµ¬í˜„ ê°€ëŠ¥

### 5. **ë””ë²„ê¹… ìš©ì´ì„±**
- ìƒì„¸í•œ ë¡œê¹… ë° ìƒíƒœ ì¶”ì 
- ê° ë‹¨ê³„ë³„ ê²°ê³¼ í™•ì¸ ê°€ëŠ¥

## ğŸ”§ ê°œë°œì ê°€ì´ë“œ

### ìƒˆë¡œìš´ ê²€ì¦ ë‹¨ê³„ ì¶”ê°€
1. `SingleTextState`ì— í•„ìš”í•œ í•„ë“œ ì¶”ê°€
2. ìƒˆ ë…¸ë“œ í•¨ìˆ˜ êµ¬í˜„
3. ë¼ìš°í„° í•¨ìˆ˜ ìˆ˜ì •
4. ì„œë¸Œê·¸ë˜í”„ì— ë…¸ë“œ ë° ì—£ì§€ ì¶”ê°€

### ì»¤ìŠ¤í…€ ë¼ìš°íŒ… ì¡°ê±´
```python
def custom_router(state: SingleTextState) -> Literal["next_step", "retry", "completed"]:
    # ì»¤ìŠ¤í…€ ì¡°ê±´ êµ¬í˜„
    if custom_condition(state):
        return "next_step"
    elif should_retry(state):
        return "retry"
    return "completed"
```

## ğŸ“ˆ ì„±ëŠ¥ ìµœì í™”

- **ë³‘ë ¬ ì²˜ë¦¬**: ì—¬ëŸ¬ í…ìŠ¤íŠ¸ ë™ì‹œ ì²˜ë¦¬ ê°€ëŠ¥ (í–¥í›„ êµ¬í˜„)
- **ìºì‹±**: LLM ì‘ë‹µ ìºì‹±ìœ¼ë¡œ ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
- **ë°°ì¹˜ ì²˜ë¦¬**: ìœ ì‚¬í•œ í…ìŠ¤íŠ¸ ê·¸ë£¹ë³„ ë°°ì¹˜ ì²˜ë¦¬

## ğŸ¤ ê¸°ì—¬ ë°©ë²•

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests if applicable
5. Submit a pull request

## ğŸ“„ ë¼ì´ì„¼ìŠ¤

This project is licensed under the MIT License.
